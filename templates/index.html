<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>UNITY Certificate Authority</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background: #f7fafc; }
    .card { border-radius: 12px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace; }
    .small-note { font-size: .85rem; color: #6c757d; }
  </style>
</head>
<body>
  <div class="container py-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1 class="h4">UNITY Certificate Authority</h1>
      <div>
        <button class="btn btn-outline-primary me-2" data-bs-toggle="modal" data-bs-target="#createProfileModal">+ Create Signing Profile</button>
        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#createCaModal">+ Create New CA</button>
      </div>
    </div>

    <!-- Flash messages -->
    {% with messages = get_flashed_messages() %}
      {% if messages %}
        <div class="mb-3">
          {% for m in messages %}
            <div class="alert alert-info">{{ m }}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <div class="row g-4">
      <!-- Generate certificate -->
      <div class="col-md-6">
        <div class="card p-4 shadow-sm">
          <h5 class="mb-3">Generate Certificate</h5>
          <form action="{{ url_for('index') }}" method="POST">
            <div class="mb-3">
              <label class="form-label">Common Name (CN)</label>
              <input name="cn" class="form-control" placeholder="service.example.com" required>
              <div class="small-note">Allowed characters: letters, numbers, dots, hyphens, spaces (filenames sanitized).</div>
            </div>

            <div class="mb-3">
              <label class="form-label">Subject Alternative Name (SAN)</label>
              <!-- UPDATED placeholder to show comma-separated hint -->
              <input name="san" class="form-control" placeholder="1.1.1.1 or test.com,test1.com" required>
              <div class="small-note">Comma-separated values supported (e.g., <span class="mono">1.1.1.1, unity.lan, test.com</span>). IPs are auto-detected.</div>
            </div>

            <div class="mb-3">
              <label class="form-label">Signing CA</label>
              <select name="ca" class="form-select" required>
                {% if available_cas|length == 0 %}
                  <option value="">No CAs available - create a CA first</option>
                {% endif %}
                {% for ca in available_cas %}
                  <option value="{{ ca.safe }}">{{ ca.display }} ({{ ca.metadata.type }})</option>
                {% endfor %}
              </select>
            </div>

            <div class="mb-3">
              <label class="form-label">Signing Profile</label>
              <select name="profile" class="form-select" required>
                {% for p in signing_profiles %}
                  <option value="{{ p.safe }}">{{ p.display }}</option>
                {% endfor %}
              </select>
              <div class="small-note">Profile provides default subject fields (C, O, OU) and validity days.</div>
            </div>

            <div class="d-flex gap-2">
              <button class="btn btn-primary">Generate Certificate</button>
              <a class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#createProfileModal">New Profile</a>
            </div>
          </form>
        </div>
      </div>

      <!-- Submit CSR -->
      <div class="col-md-6">
        <div class="card p-4 shadow-sm">
          <h5 class="mb-3">Submit CSR (paste PEM)</h5>
          <form action="{{ url_for('submit_csr') }}" method="POST">
            <div class="mb-3">
              <label class="form-label">CSR (PEM)</label>
              <textarea name="csr" class="form-control mono" rows="8" placeholder="-----BEGIN CERTIFICATE REQUEST-----" required></textarea>
            </div>

            <div class="mb-3">
              <label class="form-label">Signing CA</label>
              <select name="csr_ca" class="form-select" required>
                {% if available_cas|length == 0 %}
                  <option value="">No CAs available</option>
                {% endif %}
                {% for ca in available_cas %}
                  <option value="{{ ca.safe }}">{{ ca.display }} ({{ ca.metadata.type }})</option>
                {% endfor %}
              </select>
            </div>

            <div class="mb-3">
              <label class="form-label">Signing Profile</label>
              <select name="csr_profile" class="form-select">
                {% for p in signing_profiles %}
                  <option value="{{ p.safe }}">{{ p.display }}</option>
                {% endfor %}
              </select>
            </div>

            <button class="btn btn-primary">Sign CSR</button>
          </form>
        </div>
      </div>
    </div>

    <!-- Issued certificates -->
    <div class="card mt-4 p-3 shadow-sm">
      <h5>Issued Certificates</h5>
      <div class="table-responsive">
        <table class="table table-sm">
          <thead class="table-light">
            <tr><th>Certificate</th><th>Expiry</th><th>Actions</th></tr>
          </thead>
          <tbody>
            {% for cert in certs %}
              <tr>
                <td class="mono">{{ cert.name }}</td>
                <td>{{ cert.expiry }}</td>
                <td>
                  <a href="{{ url_for('download_cert', filename=cert.name) }}" class="btn btn-sm btn-primary">Download Cert</a>
                  <a href="{{ url_for('download_key', filename=cert.name.replace('.crt', '.key')) }}" class="btn btn-sm btn-secondary">Download Key</a>
                  <a href="{{ url_for('delete_cert', filename=cert.name) }}" class="btn btn-sm btn-danger" onclick="return confirm('Delete certificate and related files?')">Delete</a>
                </td>
              </tr>
            {% else %}
              <tr><td colspan="3" class="text-muted">No certificates issued yet.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Available CAs -->
    <div class="card mt-4 p-3 shadow-sm">
      <h5>Available CAs</h5>
      <div class="table-responsive">
        <table class="table table-sm">
          <thead class="table-light"><tr><th>Name</th><th>Type</th><th>Subject</th><th>Actions</th></tr></thead>
          <tbody>
            {% for ca in available_cas %}
              <tr>
                <td>{{ ca.display }}</td>
                <td>{{ ca.metadata.type }}</td>
                <td class="mono">{{ ca.metadata.subject }}</td>
                <td>
                  <!-- NEW: Download CA Cert (cert only) -->
                  <a href="{{ url_for('download_ca_cert', safe=ca.safe) }}" class="btn btn-sm btn-primary">Download CA Cert</a>
                </td>
              </tr>
            {% else %}
              <tr><td colspan="4" class="text-muted">No CAs yet.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

  </div>

  <!-- Create CA Modal -->
  <div class="modal fade" id="createCaModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <form class="modal-content" method="POST" action="{{ url_for('create_ca') }}">
        <div class="modal-header">
          <h5 class="modal-title">Create New CA</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">CA Display Name</label>
            <input name="display_name" class="form-control" placeholder="e.g. My Root CA" required>
            <div class="small-note">Visible name (may include spaces). Filenames are sanitized.</div>
          </div>

          <div class="mb-3">
            <label class="form-label">CA Type</label>
            <select name="ca_type" id="caType" class="form-select" onchange="toggleParent()" required>
              <option value="root">Root (self-signed)</option>
              <option value="issuing">Issuing (signed by Root)</option>
            </select>
          </div>

          <div id="parentDiv" style="display:none" class="mb-3">
            <label class="form-label">Signing Root CA</label>
            <select name="parent_ca" class="form-select">
              {% for c in available_cas %}
                {% if c.metadata.type == 'root' %}
                  <option value="{{ c.safe }}">{{ c.display }}</option>
                {% endif %}
              {% endfor %}
            </select>
            <div class="small-note">Root CAs only.</div>
          </div>

          <hr>
          <div class="mb-2"><strong>Subject Fields</strong></div>
          <div class="small-note mb-2">Provide the subject that will be used for this CA. At least CN is required. Country (C) should be 2-letter code if used.</div>

          <div class="row g-2">
            <div class="col-3">
              <label class="form-label">C</label>
              <input name="C" class="form-control" placeholder="GB">
            </div>
            <div class="col-5">
              <label class="form-label">O</label>
              <input name="O" class="form-control" placeholder="Organization">
            </div>
            <div class="col-4">
              <label class="form-label">OU</label>
              <input name="OU" class="form-control" placeholder="Org Unit">
            </div>
          </div>

          <div class="mt-3">
            <label class="form-label">CN (Common Name)</label>
            <input name="CN" class="form-control" placeholder="e.g. root.example.com" required>
          </div>
        </div>

        <div class="modal-footer">
          <button class="btn btn-success">Create CA</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Create Profile Modal -->
  <div class="modal fade" id="createProfileModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <form class="modal-content" method="POST" action="{{ url_for('create_profile') }}">
        <div class="modal-header">
          <h5 class="modal-title">Create Signing Profile</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Profile Display Name</label>
            <input name="profile_display" class="form-control" placeholder="unity-default" required>
            <div class="small-note">Used to select a profile in the UI. Filenames sanitized automatically.</div>
          </div>

          <div class="row g-2">
            <div class="col-3">
              <label class="form-label">C</label>
              <input name="profile_C" class="form-control" placeholder="GB">
            </div>
            <div class="col-5">
              <label class="form-label">O</label>
              <input name="profile_O" class="form-control" placeholder="Organization">
            </div>
            <div class="col-4">
              <label class="form-label">OU</label>
              <input name="profile_OU" class="form-control" placeholder="Org Unit">
            </div>
          </div>

          <div class="mt-3">
            <label class="form-label">Default validity (days)</label>
            <input name="profile_days" type="number" class="form-control" value="365" min="1">
          </div>
        </div>

        <div class="modal-footer">
          <button class="btn btn-success">Create Profile</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </form>
    </div>
  </div>

<script>
function toggleParent() {
  const t = document.getElementById('caType').value;
  document.getElementById('parentDiv').style.display = (t === 'issuing') ? 'block' : 'none';
}
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
